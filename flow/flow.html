<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Indego Bike Share Flow Visualization</title>
  
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <script src="https://unpkg.com/deck.gl@^8.8.0/dist.min.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #333;
      background-color: #f8f9fa;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #sidebar {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 320px;
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 20px;
      border-radius: 8px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      z-index: 100;
      transition: all 0.3s ease;
    }

    #station-info {
      margin-top: 15px;
    }

    #station-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
      color: #222;
    }

    .chart-container {
      margin-top: 25px;
      background-color: #f9f9f9;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .chart-title {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 14px;
      color: #444;
    }

    select {
      width: 100%;
      padding: 8px 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ddd;
      background-color: #fff;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      transition: border-color 0.2s;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 30px;
    }

    .select-container {
      position: relative;
      width: 100%;
    }

    .select-container::after {
      content: "\F282"; /* Bootstrap down icon */
      font-family: "bootstrap-icons";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #555;
      font-size: 14px;
    }

    select:hover {
      border-color: #aaa;
    }

    select:focus {
      border-color: #4285f4;
      outline: none;
    }

    .legend {
      padding: 15px;
      background: white;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #eee;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .legend h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 16px;
      color: #333;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .legend-color {
      width: 24px;
      height: 8px;
      margin-right: 10px;
      border-radius: 2px;
    }

    .info-panel {
      background-color: white;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
      font-size: 13px;
      line-height: 1.6;
      border: 1px solid #eee;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    button {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 12px;
      transition: background-color 0.2s;
      font-weight: 500;
    }

    button:hover {
      background-color: #3367d6;
    }
    
    button:disabled {
      background-color: #a0a0a0;
      cursor: not-allowed;
    }

    #title-bar {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
      max-width: 400px;
    }

    #title-bar h1 {
      margin: 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }

    #title-bar p {
      margin: 8px 0 0 0;
      font-size: 16px;
      color: #666;
    }
    
    #title-bar a {
      color: #4285f4;
      text-decoration: none;
      font-weight: 500;
    }
    
    #title-bar a:hover {
      text-decoration: underline;
    }
    
    #panel-toggle {
      position: absolute;
      top: 130px;
      left: 20px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 12px 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      z-index: 100;
      font-weight: 500;
      display: flex;
      align-items: center;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    
    #panel-toggle i {
      margin-right: 8px;
    }
    
    #panel-toggle:hover {
      background-color: #3367d6;
    }
    
    .tooltip {
      position: absolute;
      background: rgba(33, 33, 33, 0.9);
      color: white;
      padding: 10px 14px;
      border-radius: 6px;
      pointer-events: none;
      z-index: 10;
      font-size: 13px;
      max-width: 220px;
      line-height: 1.4;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: none;
    }

    .chart-tooltip {
      position: absolute;
      background-color: rgba(33, 33, 33, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      z-index: 999;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: opacity 0.2s;
      line-height: 1.4;
    }
    
    .month-selector {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      background-color: #f0f4f9;
      padding: 12px 15px;
      border-radius: 6px;
      border: 1px solid #dde6f1;
    }
    
    .month-selector h3 {
      margin-right: 12px;
    }
    
    .month-selector h3 {
      margin: 0;
      font-size: 14px;
      color: #444;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .month-selector select {
      margin: 0;
      flex-grow: 1;
    }
    
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(33, 33, 33, 0.85);
      color: white;
      padding: 15px 25px;
      border-radius: 6px;
      font-size: 16px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .loading-text {
      display: flex;
      align-items: center;
    }
    
    .loading-text .spinner {
      margin-right: 12px;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    
    #animation-controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
      width: 500px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    #animation-controls > * {
      margin-bottom: 15px;
    }
    
    #animation-controls > *:last-child {
      margin-bottom: 0;
    }
    
    .progress-container {
      width: 100%;
      height: 8px;
      background-color: #eee;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background-color: #4285f4;
      width: 0%;
      transition: width 0.2s;
    }
    
    .animation-buttons {
      display: flex;
      justify-content: center;
    }
    
    .animation-buttons button:first-child {
      margin-right: 15px;
    }
    
    .animation-month-display {
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .animation-title {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }
    
    #animation-play-btn {
      background-color: #4285f4;
      padding: 8px 20px;
      display: flex;
      align-items: center;
    }
    
    #animation-play-btn i {
      margin-right: 8px;
    }
    
    #animation-play-btn:disabled {
      background-color: #a0a0a0;
      cursor: not-allowed;
    }
    
    #animation-stop-btn {
      background-color: #db4437;
    }
    
    .layer-toggle {
      margin-top: 15px;
      background-color: #f0f4f9;
      padding: 12px 15px;
      border-radius: 6px;
      border: 1px solid #dde6f1;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
      margin-left: 10px;
    }
    
    .toggle-switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4285f4;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    .toggle-label {
      display: flex;
      align-items: center;
      font-size: 14px;
      font-weight: 500;
    }
    
    .no-data {
      color: #888;
      font-style: italic;
      text-align: center;
      padding: 20px 0;
    }
    
    @media (max-width: 768px) {
      #sidebar {
        width: 280px;
      }
      
      #title-bar {
        max-width: 250px;
      }
      
      #animation-controls {
        width: 90%;
      }
    }

    .zoom-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(33, 33, 33, 0.85);
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div id="title-bar">
    <h1>Philadelphia Indego Bike Share</h1>
    <p>January 2024 Flow Data Visualization</p>
    <p style="font-size: 13px; margin-top: 5px;">
      Data Source: <a href="https://www.rideindego.com/about/data/" target="_blank">Indego Data</a> | Data Processing: <a href="https://github.com/BiuLei0527/CASA0003_Group_Assessment" target="_blank">Github</a>
    </p>
  </div>
  
  <button id="panel-toggle">
    <i class="bi bi-layout-sidebar-reverse"></i> Toggle Panel
  </button>
  
  <div id="sidebar">
    <div class="month-selector">
      <h3>Month:</h3>
      <div class="select-container">
        <select id="month-dropdown">
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
      </div>
    </div>
    
    <div class="layer-toggle">
      <label class="toggle-label">
        Show Census Tracts
        <span class="toggle-switch">
          <input type="checkbox" id="census-toggle">
          <span class="toggle-slider"></span>
        </span>
      </label>
    </div>
    
    <div class="layer-toggle">
      <label class="toggle-label">
        Show Other Stations
        <span class="toggle-switch">
          <input type="checkbox" id="other_stations_toggle" checked>
          <span class="toggle-slider"></span>
        </span>
      </label>
    </div>
    
    <div class="layer-toggle">
      <label class="toggle-label">
        Show High Volume Flows (>5)
        <span class="toggle-switch">
          <input type="checkbox" id="trip-count-toggle">
          <span class="toggle-slider"></span>
        </span>
      </label>
    </div>
    
    <div class="legend">
      <h3>Flow Legend</h3>
      <div class="legend-item">
        <div class="legend-color" style="background-color: rgba(107, 174, 214, 0.7);"></div>
        <span>Inbound Trips</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: rgba(253, 141, 60, 0.7);"></div>
        <span>Outbound Trips</span>
      </div>
      <div id="trip-count-legend" style="margin-top: 10px; font-size: 12px; color: #666; display: none;">
        <i class="bi bi-info-circle"></i> Only showing flows with more than 5 trips
      </div>
    </div>
    
    <div class="station-selector">
      <div class="section-title">Select Station</div>
      <div class="select-container">
        <select id="station-dropdown">
          <option value="">Select a station...</option>
        </select>
      </div>
    </div>
    
    <div id="station-info">
      <p>Select a station from the dropdown or click on a station to view its flow data and daily activity.</p>
    </div>
    
    <div id="station-charts" style="display: none;">
      <div class="chart-container">
        <div class="chart-title">Daily Borrow Count</div>
        <div id="borrow-chart"></div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Daily Return Count</div>
        <div id="return-chart"></div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Daily Net Activity</div>
        <div id="net-chart"></div>
      </div>
    </div>
    
    <div class="info-panel">
      <p>This visualization shows bike share flow data for Philadelphia's Indego system in 2024. The thickness of flow lines represents the trip count between stations.</p>
      <p>Click on any station to filter flows and see only the trips starting or ending at that station. The map will zoom to the selected station.</p>
      <button id="reset-view">Reset View</button>
      <button id="start-animation" style="background-color: #0f9d58; margin-left: 10px;">
        <i class="bi bi-play-fill"></i> Start Animation
      </button>
    </div>
  </div>
  
  <div id="animation-controls" style="display: none;">
    <div class="animation-title">Station Flow Animation</div>
    <div class="animation-month-display">Current Month: January</div>
    <div class="progress-container">
      <div class="progress-bar" id="animation-progress"></div>
    </div>
    <div class="animation-buttons">
      <button id="animation-play-btn">
        <i class="bi bi-play-fill"></i> Play
      </button>
      <button id="animation-stop-btn">
        <i class="bi bi-stop-fill"></i> Stop
      </button>
    </div>
  </div>
  
  <div id="loading">
    <div class="loading-text">
      <div class="spinner"></div>
      <span>Loading data...</span>
    </div>
  </div>
  
  <div id="tooltip" class="tooltip"></div>
  
  <div id="zoom-notification" class="zoom-notification">Zooming to station</div>

  <script>
    var mapbox_tk = 'pk.eyJ1IjoiY2FzYWxlaTA1MjciLCJhIjoiY202ZXgyYzMzMDl1bjJxcTBmMngxd2cwNiJ9.GJxy6g5lb4gAK3wOW5PdXQ';
    var flow_data_url = 'https://raw.githubusercontent.com/BiuLei0527/CASA0003_Group_Assessment/main/Flow%20data/od_flows_month_';
    var sta_act_url = 'https://raw.githubusercontent.com/BiuLei0527/CASA0003_Group_Assessment/main/Count/station_daily_activity_month_';
    var census_url = 'https://raw.githubusercontent.com/BiuLei0527/CASA0003_Group_Assessment/main/Additional_data/Census_Tracts_2010.geojson';
    
    var anim_dur = 1000;
    var anim_pause = 2000;
    var sta_zoom = 14;
    var min_trip = 5; 
    
    var sb_vis = true;
    var cur_month = 1;
    var show_other = true;
    var filter_trip = false;
    
    var anim_play = false;
    var anim_frame = null;
    var anim_timeout = null;
    var anim_cache = {};
    
    var census_data = null;
    var census_added = false;
    var census_vis = false;
    
    mapboxgl.accessToken = mapbox_tk;
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-75.16, 39.95],
      zoom: 12,
      minZoom: 10,
      maxZoom: 17
    });
    
    map.addControl(new mapboxgl.NavigationControl({
      showCompass: true,
      showZoom: true,
      visualizePitch: true
    }), 'bottom-right');
    
    var deck_ovl = new deck.MapboxOverlay({
      layers: [],
      getTooltip: function({object}) {
        return null;
      }
    });
    map.addControl(deck_ovl);
    
    var flow_data = null;
    var sta_data = null;
    var sel_sta = null;
    var is_load = false;
    var def_sta = "10th & Chestnut";
    
    var in_col = [107, 174, 214, 180];
    var out_col = [253, 141, 60, 180];
    var sta_col = [128, 128, 128];
    var sel_col = [231, 76, 60];
    
    var tt = document.getElementById('tooltip');
    var load_ind = document.getElementById('loading');
    var zoom_notif = document.getElementById('zoom-notification');
    
    function show_zoom(text, dur = 2000) {
      zoom_notif.textContent = text;
      zoom_notif.style.opacity = "1";
      
      setTimeout(() => {
        zoom_notif.style.opacity = "0";
      }, dur);
    }
    
    function zoom_sta(sta_name) {
      if (!sta_data || !sta_data[sta_name]) return;
      
      var pos = sta_data[sta_name].position;
      
      if (!pos || pos.length !== 2) return;
      
      map.flyTo({
        center: pos,
        zoom: sta_zoom,
        duration: 1500,
        essential: true
      });
      
      show_zoom(`Zooming to ${sta_name}`);
    }
    
    function load_census() {
      fetch(census_url)
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Failed to load census tract data');
          }
          return response.json();
        })
        .then(function(data) {
          census_data = data;
          
          if (!map.loaded()) {
            map.on('load', add_census);
          } else {
            add_census();
          }
        })
        .catch(function(error) {
          console.error('Error loading census tract data:', error);
        });
    }
    
    function add_census() {
      if (!census_data || census_added) return;
      
      try {
        map.addSource('census-tracts', {
          type: 'geojson',
          data: census_data
        });
        
        map.addLayer({
          id: 'census-tracts-fill',
          type: 'fill',
          source: 'census-tracts',
          layout: {
            visibility: 'none'
          },
          paint: {
            'fill-color': 'rgba(132, 175, 209, 0.2)',
            'fill-outline-color': 'rgba(66, 133, 244, 0.8)'
          }
        });
        
        map.addLayer({
          id: 'census-tracts-line',
          type: 'line',
          source: 'census-tracts',
          layout: {
            visibility: 'none'
          },
          paint: {
            'line-color': 'rgba(66, 133, 244, 0.8)',
            'line-width': 1
          }
        });
        
        census_added = true;
        
        var census_tog = document.getElementById('census-toggle');
        census_tog.addEventListener('change', function(e) {
          if (census_added) {
            var vis = e.target.checked ? 'visible' : 'none';
            map.setLayoutProperty('census-tracts-fill', 'visibility', vis);
            map.setLayoutProperty('census-tracts-line', 'visibility', vis);
            census_vis = e.target.checked;
          }
        });
      } catch (error) {
        console.error('Error adding census tract layers:', error);
      }
    }
    
    document.getElementById('other_stations_toggle').addEventListener('change', function(e) {
      show_other = e.target.checked;
      render_flows();
    });
    
    document.getElementById('trip-count-toggle').addEventListener('change', function(e) {
      filter_trip = e.target.checked;
      render_flows();
      
      if (filter_trip) {
        show_zoom(`Showing only flows with more than ${min_trip} trips`);
        document.getElementById('trip-count-legend').style.display = 'block';
      } else {
        show_zoom('Showing all flows');
        document.getElementById('trip-count-legend').style.display = 'none';
      }
    });
    
    var month_drop = document.getElementById('month-dropdown');
    month_drop.addEventListener('change', function(e) {
      var sel_month = parseInt(e.target.value);
      if (sel_month !== cur_month) {
        cur_month = sel_month;
        load_data(cur_month);
      }
    });
    
    function load_data(month) {
      if (is_load) return;
      
      is_load = true;
      load_ind.style.display = 'block';
      
      var month_names = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
      document.querySelector('#title-bar p:first-of-type').textContent = `${month_names[month-1]} 2024 Flow Data Visualization`;
      
      if (!anim_play) {
        flow_data = null;
        sta_data = null;
      }
      
      month_drop.value = month.toString();
      document.querySelector('.animation-month-display').textContent = `Current Month: ${month_names[month-1]}`;
      
      var prog_bar = document.getElementById('animation-progress');
      if (prog_bar) {
        prog_bar.style.width = `${((month - 1) / 11) * 100}%`;
      }
      
      if (anim_cache[month]) {
        flow_data = anim_cache[month].flow_data;
        sta_data = anim_cache[month].sta_data;
        
        update_ui(month);
        return;
      }
      
      var flow_url = `${flow_data_url}${month}.geojson`;
      var act_url = `${sta_act_url}${month}.geojson`;
      
      Promise.all([
        fetch(flow_url).then(function(resp) {
          if (!resp.ok) {
            throw new Error(`Failed to load flow data for month ${month}`);
          }
          return resp.json();
        }),
        fetch(act_url).then(function(resp) {
          if (!resp.ok) {
            throw new Error(`Failed to load station activity data for month ${month}`);
          }
          return resp.json();
        })
      ]).then(function(results) {
        var flow_geo = results[0];
        var act_geo = results[1];
        
        var proc_flow = flow_geo.features.map(function(f) {
          var props = f.properties;
          var geom = f.geometry;
          return {
            start_name: props.start_station_name,
            end_name: props.end_station_name,
            start_pos: [props.start_lon, props.start_lat],
            end_pos: [props.end_lon, props.end_lat],
            trips: props.trip_count,
            path: geom.coordinates
          };
        }).filter(function(flow) {
          return flow.start_name !== "Ridge & Ferry" && 
                 flow.end_name !== "Ridge & Ferry";
        });
        
        var proc_sta = {};
        act_geo.features.forEach(function(f) {
          var props = f.properties;
          var sta_name = props.station_name;
          
          if (sta_name === "Ridge & Ferry") return;
          
          if (!proc_sta[sta_name]) {
            proc_sta[sta_name] = {
              position: [props.lon, props.lat],
              daily: []
            };
          }
          
          proc_sta[sta_name].daily.push({
            date: props.date,
            borrows: props.borrow_count,
            returns: props.return_count,
            net: props.net_activity
          });
        });
        
        if (anim_play) {
          anim_cache[month] = {
            flow_data: proc_flow,
            sta_data: proc_sta
          };
        }
        
        flow_data = proc_flow;
        sta_data = proc_sta;
        
        update_ui(month);
      })
      .catch(function(error) {
        console.error('Error loading data:', error);
        alert(`Error loading data for month ${month}: ${error.message}`);
        
        is_load = false;
        load_ind.style.display = 'none';
        
        var play_btn = document.getElementById('animation-play-btn');
        if (play_btn) play_btn.disabled = true;
      });
    }
    
    function update_ui(month) {
      var sta_drop = document.getElementById('station-dropdown');
      sta_drop.innerHTML = '<option value="">Select a station...</option>';
      
      var sta_names = Object.keys(sta_data).sort();
      
      sta_names.forEach(function(name) {
        var opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sta_drop.appendChild(opt);
      });
      
      if (!sel_sta && sta_data[def_sta]) {
        sel_sta = def_sta;
      }
      
      if (sel_sta && sta_data[sel_sta]) {
        sta_drop.value = sel_sta;
      } else if (sta_names.length > 0) {
        sel_sta = sta_names[0];
        sta_drop.value = sel_sta;
      }
      
      update_sta_info(sel_sta);
      
      update_viz();
      
      is_load = false;
      load_ind.style.display = 'none';
      
      if (anim_play && month < 12) {
        anim_timeout = setTimeout(function() {
          cur_month = month + 1;
          month_drop.value = cur_month.toString();
          load_data(cur_month);
        }, anim_pause);
      } else if (anim_play && month === 12) {
        stop_anim();
      }
    }
    
    function update_viz() {
      render_flows();
    }
    
    function render_flows() {
      if (!flow_data || !sta_data || !sel_sta) return;
      
      var vis_flows = flow_data.filter(function(flow) {
        var sta_match = flow.start_name === sel_sta || 
                       flow.end_name === sel_sta;
        
        if (filter_trip) {
          return sta_match && flow.trips > min_trip;
        }
        
        return sta_match;
      });
      
      var conn_stas = new Set();
      vis_flows.forEach(function(flow) {
        conn_stas.add(flow.start_name);
        conn_stas.add(flow.end_name);
      });
      
      var flow_lyrs = [
        new deck.PathLayer({
          id: 'in-flows',
          data: vis_flows.filter(function(f) { return f.end_name === sel_sta; }),
          pickable: true,
          widthUnits: 'pixels',
          getPath: function(d) { return [d.start_pos, d.end_pos]; },
          getColor: in_col,
          getWidth: function(d) { return Math.sqrt(d.trips) * 2; },
          jointRounded: true,
          capRounded: true,
          billboard: false,
          getHeight: function() { return 0.5; },
          widthMinPixels: 2,
          widthMaxPixels: 20,
          onHover: function(info) {
            if (info.object) {
              tt.style.display = 'block';
              tt.style.left = `${info.x + 10}px`;
              tt.style.top = `${info.y + 10}px`;
              
              var start = info.object.start_name || '';
              var end = info.object.end_name || '';
              var trips = info.object.trips || 0;
              
              tt.textContent = `${start} → ${end} (${trips} trips)`;
            } else {
              tt.style.display = 'none';
            }
          }
        }),
        
        new deck.PathLayer({
          id: 'out-flows',
          data: vis_flows.filter(function(f) { return f.start_name === sel_sta; }),
          pickable: true,
          widthUnits: 'pixels',
          getPath: function(d) { return [d.start_pos, d.end_pos]; },
          getColor: out_col,
          getWidth: function(d) { return Math.sqrt(d.trips) * 2; },
          jointRounded: true,
          capRounded: true,
          billboard: false,
          getHeight: function() { return 0.5; },
          widthMinPixels: 2,
          widthMaxPixels: 20,
          onHover: function(info) {
            if (info.object) {
              tt.style.display = 'block';
              tt.style.left = `${info.x + 10}px`;
              tt.style.top = `${info.y + 10}px`;
              
              var start = info.object.start_name || '';
              var end = info.object.end_name || '';
              var trips = info.object.trips || 0;
              
              tt.textContent = `${start} → ${end} (${trips} trips)`;
            } else {
              tt.style.display = 'none';
            }
          }
        })
      ];
      
      var sta_pts = Object.entries(sta_data).map(function(entry) {
        var name = entry[0];
        var data = entry[1];
        
        var t_borrows = data.daily.reduce(function(sum, day) { return sum + (day.borrows || 0); }, 0);
        var t_returns = data.daily.reduce(function(sum, day) { return sum + (day.returns || 0); }, 0);
        var net_act = t_returns - t_borrows;
        
        return {
          name: name,
          pos: data.position,
          borrows: t_borrows,
          returns: t_returns,
          net: net_act,
          sel: name === sel_sta,
          vis: show_other || name === sel_sta || conn_stas.has(name)
        };
      }).filter(function(station) {
        return station.vis;
      });
      
      var sta_lyr = new deck.ScatterplotLayer({
        id: 'stations',
        data: sta_pts,
        pickable: true,
        opacity: 0.85,
        stroked: true,
        filled: true,
        radiusUnits: 'pixels',
        getPosition: function(d) { return d.pos; },
        getRadius: function(d) { return d.sel ? 12 : 8; },
        getFillColor: function(d) { return d.sel ? sel_col : sta_col; },
        getLineColor: function(d) { return d.sel ? [255, 255, 255] : [200, 200, 200]; },
        getLineWidth: function(d) { return d.sel ? 2 : 1; },
        onClick: function(info) {
          if (info.object) {
            sel_sta = info.object.name;
            document.getElementById('station-dropdown').value = sel_sta;
            update_sta_info(sel_sta);
            render_flows();
            
            zoom_sta(sel_sta);
            
            if (filter_trip) {
              show_zoom(`${sel_sta} - Showing flows with more than ${min_trip} trips`);
            }
          }
        },
        onHover: function(info) {
          if (info.object) {
            tt.style.display = 'block';
            tt.style.left = `${info.x + 10}px`;
            tt.style.top = `${info.y + 10}px`;
            
            var name = info.object.name || '';
            var borrows = info.object.borrows || 0;
            var returns = info.object.returns || 0;
            var net = info.object.net || 0;
            
            tt.innerHTML = `
              <strong>${name}</strong><br>
              Borrows: ${borrows}<br>
              Returns: ${returns}<br>
              Net: ${net > 0 ? '+' : ''}${net}
            `;
          } else {
            tt.style.display = 'none';
          }
        }
      });
      
      deck_ovl.setProps({
        layers: [...flow_lyrs, sta_lyr]
      });
    }
    
    function update_trip_ind() {
      document.getElementById('trip-count-legend').style.display = 
        filter_trip ? 'block' : 'none';
    }
    
    function update_sta_info(sta_name) {
      var info_div = document.getElementById('station-info');
      var charts_div = document.getElementById('station-charts');
      
      if (!sta_name || !sta_data || !sta_data[sta_name]) {
        info_div.innerHTML = '<p>Select a station from the dropdown or click on a station to view its flow data and daily activity.</p>';
        charts_div.style.display = 'none';
        return;
      }
      
      var sta_info = sta_data[sta_name];
      
      var t_borrows = sta_info.daily.reduce(function(sum, day) { return sum + (day.borrows || 0); }, 0);
      var t_returns = sta_info.daily.reduce(function(sum, day) { return sum + (day.returns || 0); }, 0);
      var net_act = t_returns - t_borrows;
      
      info_div.innerHTML = `
        <div id="station-title">${sta_name}</div>
        <p>
          Total Borrows: <strong>${t_borrows}</strong><br>
          Total Returns: <strong>${t_returns}</strong><br>
          Net Activity: <strong>${net_act > 0 ? '+' : ''}${net_act}</strong>
        </p>
      `;
      
      charts_div.style.display = 'block';
      
      var sort_act = [...sta_info.daily].sort(function(a, b) {
        var date_a = new Date(a.date);
        var date_b = new Date(b.date);
        
        return isNaN(date_a) || isNaN(date_b) ? 0 : date_a - date_b;
      });
      
      draw_chart('borrow-chart', sort_act, 'borrows', 'steelblue');
      draw_chart('return-chart', sort_act, 'returns', 'darkgreen');
      draw_net_chart('net-chart', sort_act);
    }
    
    function draw_chart(cont_id, data, prop, color) {
      var cont = document.getElementById(cont_id);
      if (!cont) return;
      
      cont.innerHTML = '';
      
      if (!data || data.length === 0) {
        cont.innerHTML = '<p class="no-data">No data available</p>';
        return;
      }
      
      var margin = { top: 10, right: 10, bottom: 30, left: 40 };
      var width = cont.clientWidth - margin.left - margin.right;
      var height = 150 - margin.top - margin.bottom;
      
      var svg = d3.select(`#${cont_id}`).append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
      
      var valid = data.filter(function(d) {
        var date = new Date(d.date);
        return !isNaN(date) && d[prop] !== undefined && d[prop] !== null;
      });
      
      if (valid.length === 0) {
        cont.innerHTML = '<p class="no-data">No valid data available</p>';
        return;
      }
      
      var x = d3.scaleTime()
        .domain(d3.extent(valid, function(d) { return new Date(d.date); }))
        .range([0, width]);
      
      var y = d3.scaleLinear()
        .domain([0, d3.max(valid, function(d) { return d[prop]; }) * 1.1 || 10])
        .range([height, 0]);
      
      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%d %b')))
        .selectAll('text')
        .style('font-size', '10px');
      
      svg.append('g')
        .call(d3.axisLeft(y).ticks(5))
        .selectAll('text')
        .style('font-size', '10px');
      
      svg.append('path')
        .datum(valid)
        .attr('fill', 'none')
        .attr('stroke', color)
        .attr('stroke-width', 2)
        .attr('d', d3.line()
          .x(function(d) { return x(new Date(d.date)); })
          .y(function(d) { return y(d[prop]); })
        );
      
      svg.append('path')
        .datum(valid)
        .attr('fill', color)
        .attr('fill-opacity', 0.1)
        .attr('d', d3.area()
          .x(function(d) { return x(new Date(d.date)); })
          .y0(height)
          .y1(function(d) { return y(d[prop]); })
        );
      
      var chart_tt = d3.select('body').select('.chart-tooltip');
      if (chart_tt.empty()) {
        chart_tt = d3.select('body')
          .append('div')
          .attr('class', 'chart-tooltip')
          .style('opacity', 0);
      }
      
      svg.selectAll('dot')
        .data(valid)
        .enter()
        .append('circle')
          .attr('r', 3)
          .attr('cx', function(d) { return x(new Date(d.date)); })
          .attr('cy', function(d) { return y(d[prop]); })
          .attr('fill', color)
          .style('opacity', 0)
          .on('mouseover', function(event, d) {
            d3.select(this).transition().duration(200).style('opacity', 1);
            chart_tt.transition().duration(200).style('opacity', 1);
            
            var date_str = new Date(d.date).toLocaleDateString();
            var val = d[prop];
            
            chart_tt.html(`Date: ${date_str}<br>Value: ${val}`)
              .style('left', (event.pageX + 10) + 'px')
              .style('top', (event.pageY - 28) + 'px');
          })
          .on('mouseout', function() {
            d3.select(this).transition().duration(500).style('opacity', 0);
            chart_tt.transition().duration(500).style('opacity', 0);
          });
    }
    
    function draw_net_chart(cont_id, data) {
      var cont = document.getElementById(cont_id);
      if (!cont) return;
      
      cont.innerHTML = '';
      
      if (!data || data.length === 0) {
        cont.innerHTML = '<p class="no-data">No data available</p>';
        return;
      }
      
      var margin = { top: 10, right: 10, bottom: 30, left: 40 };
      var width = cont.clientWidth - margin.left - margin.right;
      var height = 150 - margin.top - margin.bottom;
      
      var svg = d3.select(`#${cont_id}`).append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
      
      var valid = data.filter(function(d) {
        var date = new Date(d.date);
        return !isNaN(date) && d.net !== undefined && d.net !== null;
      });
      
      if (valid.length === 0) {
        cont.innerHTML = '<p class="no-data">No valid data available</p>';
        return;
      }
      
      var x = d3.scaleTime()
        .domain(d3.extent(valid, function(d) { return new Date(d.date); }))
        .range([0, width]);
      
      var y = d3.scaleLinear()
        .domain([
          Math.min(d3.min(valid, function(d) { return d.net; }) * 1.1, 0),
          Math.max(d3.max(valid, function(d) { return d.net; }) * 1.1, 0)
        ])
        .range([height, 0]);
      
      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%d %b')))
        .selectAll('text')
        .style('font-size', '10px');
      
      svg.append('g')
        .call(d3.axisLeft(y).ticks(5))
        .selectAll('text')
        .style('font-size', '10px');
      
      svg.append('line')
        .attr('x1', 0)
        .attr('x2', width)
        .attr('y1', y(0))
        .attr('y2', y(0))
        .attr('stroke', '#ccc')
        .attr('stroke-width', 1);
      
      svg.append('path')
        .datum(valid)
        .attr('fill', 'none')
        .attr('stroke', 'purple')
        .attr('stroke-width', 2)
        .attr('d', d3.line()
          .x(function(d) { return x(new Date(d.date)); })
          .y(function(d) { return y(d.net); })
        );
      
      svg.append('path')
        .datum(valid.filter(function(d) { return d.net >= 0; }))
        .attr('fill', 'green')
        .attr('fill-opacity', 0.1)
        .attr('d', d3.area()
          .x(function(d) { return x(new Date(d.date)); })
          .y0(y(0))
          .y1(function(d) { return y(d.net); })
        );
      
      svg.append('path')
        .datum(valid.filter(function(d) { return d.net < 0; }))
        .attr('fill', 'red')
        .attr('fill-opacity', 0.1)
        .attr('d', d3.area()
          .x(function(d) { return x(new Date(d.date)); })
          .y0(y(0))
          .y1(function(d) { return y(d.net); })
        );
      
      var chart_tt = d3.select('body').select('.chart-tooltip');
      if (chart_tt.empty()) {
        chart_tt = d3.select('body')
          .append('div')
          .attr('class', 'chart-tooltip')
          .style('opacity', 0);
      }
      
      svg.selectAll('dot')
        .data(valid)
        .enter()
        .append('circle')
          .attr('r', 3)
          .attr('cx', function(d) { return x(new Date(d.date)); })
          .attr('cy', function(d) { return y(d.net); })
          .attr('fill', function(d) { return d.net >= 0 ? 'green' : 'red'; })
          .style('opacity', 0)
          .on('mouseover', function(event, d) {
            d3.select(this).transition().duration(200).style('opacity', 1);
            chart_tt.transition().duration(200).style('opacity', 1);
            
            var date_str = new Date(d.date).toLocaleDateString();
            var net_val = d.net;
            
            chart_tt.html(`Date: ${date_str}<br>Net: ${net_val > 0 ? '+' : ''}${net_val}`)
              .style('left', (event.pageX + 10) + 'px')
              .style('top', (event.pageY - 28) + 'px');
          })
          .on('mouseout', function() {
            d3.select(this).transition().duration(500).style('opacity', 0);
            chart_tt.transition().duration(500).style('opacity', 0);
          });
    }
    
    function start_anim() {
      if (anim_play) return;
      
      document.getElementById('animation-controls').style.display = 'flex';
      
      anim_play = true;
      
      document.getElementById('month-dropdown').disabled = true;
      document.getElementById('station-dropdown').disabled = true;
      document.getElementById('reset-view').disabled = true;
      document.getElementById('start-animation').disabled = true;
      document.getElementById('census-toggle').disabled = true;
      document.getElementById('other_stations_toggle').disabled = true;
      document.getElementById('trip-count-toggle').disabled = true;
      
      cur_month = 1;
      
      document.getElementById('animation-play-btn').disabled = true;
      
      preload_anim();
    }
    
    function preload_anim() {
      is_load = true;
      load_ind.style.display = 'block';
      load_ind.querySelector('.loading-text span').textContent = 'Preparing animation...';
      
      var months = Array.from({ length: 12 }, function(_, i) { return i + 1; });
      
      var loaded = 0;
      
      var load_month = function(month) {
        var flow_url = `${flow_data_url}${month}.geojson`;
        var act_url = `${sta_act_url}${month}.geojson`;
        
        return Promise.all([
          fetch(flow_url).then(function(resp) {
            if (!resp.ok) {
              throw new Error(`Failed to load flow data for month ${month}`);
            }
            return resp.json();
          }),
          fetch(act_url).then(function(resp) {
            if (!resp.ok) {
              throw new Error(`Failed to load station activity data for month ${month}`);
            }
            return resp.json();
          })
        ]).then(function(results) {
          var flow_geo = results[0];
          var act_geo = results[1];
          
          var proc_flow = flow_geo.features.map(function(f) {
            var props = f.properties;
            var geom = f.geometry;
            return {
              start_name: props.start_station_name,
              end_name: props.end_station_name,
              start_pos: [props.start_lon, props.start_lat],
              end_pos: [props.end_lon, props.end_lat],
              trips: props.trip_count,
              path: geom.coordinates
            };
          }).filter(function(flow) {
            return flow.start_name !== "Ridge & Ferry" && 
                 flow.end_name !== "Ridge & Ferry";
          });
          
          var proc_sta = {};
          act_geo.features.forEach(function(f) {
            var props = f.properties;
            var sta_name = props.station_name;
            
            if (sta_name === "Ridge & Ferry") return;
            
            if (!proc_sta[sta_name]) {
              proc_sta[sta_name] = {
                position: [props.lon, props.lat],
                daily: []
              };
            }
            
            proc_sta[sta_name].daily.push({
              date: props.date,
              borrows: props.borrow_count,
              returns: props.return_count,
              net: props.net_activity
            });
          });
          
          anim_cache[month] = {
            flow_data: proc_flow,
            sta_data: proc_sta
          };
          
          loaded++;
          var prog_bar = document.getElementById('animation-progress');
          if (prog_bar) {
            prog_bar.style.width = `${(loaded / 12) * 100}%`;
          }
          
          if (loaded === 12) {
            is_load = false;
            load_ind.style.display = 'none';
            
            var play_btn = document.getElementById('animation-play-btn');
            if (play_btn) play_btn.disabled = false;
            
            if (prog_bar) prog_bar.style.width = '0%';
          }
        });
      };
      
      Promise.all(months.map(load_month))
        .catch(function(error) {
          console.error('Error preloading animation data:', error);
          alert('Failed to preload animation data. Please try again.');
          
          stop_anim();
          
          is_load = false;
          load_ind.style.display = 'none';
        });
    }
    
    function play_anim() {
      if (anim_timeout) return;
      
      anim_play = true;
      
      var play_btn = document.getElementById('animation-play-btn');
      if (play_btn) play_btn.disabled = true;
      
      load_data(cur_month);
    }
    
    function stop_anim() {
      if (anim_timeout) {
        clearTimeout(anim_timeout);
        anim_timeout = null;
      }
      
      if (anim_frame) {
        cancelAnimationFrame(anim_frame);
        anim_frame = null;
      }
      
      anim_play = false;
      
      var anim_ctrls = document.getElementById('animation-controls');
      if (anim_ctrls) anim_ctrls.style.display = 'none';
      
      document.getElementById('month-dropdown').disabled = false;
      document.getElementById('station-dropdown').disabled = false;
      document.getElementById('reset-view').disabled = false;
      document.getElementById('start-animation').disabled = false;
      document.getElementById('census-toggle').disabled = false;
      document.getElementById('other_stations_toggle').disabled = false;
      document.getElementById('trip-count-toggle').disabled = false;
    }
    
    document.getElementById('station-dropdown').addEventListener('change', function(e) {
      var new_sta = e.target.value || null;
      
      if (new_sta) {
        sel_sta = new_sta;
        update_sta_info(sel_sta);
        render_flows();
        
        zoom_sta(sel_sta);
        
        if (filter_trip) {
          show_zoom(`${sel_sta} - Showing flows with more than ${min_trip} trips`);
        }
      }
    });
    
    document.getElementById('reset-view').addEventListener('click', function() {
      map.flyTo({
        center: [-75.16, 39.95],
        zoom: 12,
        duration: 1000
      });
      
      show_zoom('Resetted to overview');
    });
    
    document.getElementById('start-animation').addEventListener('click', start_anim);
    
    document.getElementById('animation-play-btn').addEventListener('click', play_anim);
    
    document.getElementById('animation-stop-btn').addEventListener('click', stop_anim);
    
    document.getElementById('panel-toggle').addEventListener('click', function() {
      var sidebar = document.getElementById('sidebar');
      
      if (sb_vis) {
        sidebar.style.transform = 'translateX(calc(100% + 40px))';
      } else {
        sidebar.style.transform = 'translateX(0)';
      }
      
      sb_vis = !sb_vis;
    });
    
    map.on('click', function() {
      tt.style.display = 'none';
    });
    
    map.on('load', function() {
      load_census();
      load_data(cur_month);
      update_trip_ind();
    });
  </script>
</body>
</html>